<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emoji Accessibility Checker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
</head>
<body class="emoji-bg">

  <!-- å¿«é€Ÿè·³è½‰è‡³ä¸»è¦è¼¸å…¥å€ -->
  <a href="#userInput" class="visually-hidden-focusable">Skip to input</a>

  <div class="container">
    <h1 class="text-center mb-4">Emoji Accessibility Checker</h1>
    <p class="text-center text-muted">Is your text with emoji accessible?</p>

    <div class="input-group mb-4">
            <input type="text" id="userInput" class="form-control" placeholder="Enter your text with emoji here..." tabindex="0" />
      <button class="btn btn-primary" onclick="analyzeText()" tabindex="0">Analyze</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    // ä½¿ç”¨ Unicode Extended_Pictographic å±¬æ€§ä¾†åˆ¤æ–·å­—å…ƒæ˜¯å¦ç‚º Emoji
    function isEmoji(char) {
      return /\p{Extended_Pictographic}/u.test(char);
    }

    // åµæ¸¬é€£çºŒé‡è¤‡å‡ºç¾çš„ Emojiï¼Œé¿å…éåº¦é‡è¤‡
    function findRepeatedEmojiOnly(text) {
      const segmenter = new Intl.Segmenter("en", { granularity: "grapheme" });
      const chars = Array.from(segmenter.segment(text), s => s.segment);

      let results = [];
      let count = 1;
      let prev = chars[0];

      for (let i = 1; i < chars.length; i++) {
        if (prev === chars[i] && isEmoji(chars[i])) {
          count++;
        } else {
          if (count > 1 && isEmoji(prev)) {
            results.push({ emoji: prev, count });
          }
          count = 1;
        }
        prev = chars[i];
      }

      if (count > 1 && isEmoji(prev)) {
        results.push({ emoji: prev, count });
      }

      return results;
    }

    // è¼‰å…¥ Emoji æ”¯æ´è³‡æ–™åº«ï¼Œå–å¾—è©³ç´°è³‡è¨Šï¼ˆä¾†æºï¼šEmojibaseï¼‰
    async function loadEmojiSupportData() {
      const response = await fetch("https://cdn.jsdelivr.net/npm/emojibase-data/en/data.json");
      return await response.json();
    }

    // æ ¹æ“š Emoji å­—å…ƒï¼Œåœ¨è³‡æ–™åº«ä¸­å°‹æ‰¾å…¶è©³ç´°è³‡è¨Š
    function findEmojiInfo(emoji, dataset) {
      return dataset.find(entry => entry.emoji === emoji);
    }

    // æ ¹æ“š Unicode ç‰ˆæœ¬å›å‚³ä¸åŒæ”¯æ´æç¤ºæ–‡å­—
    function getSupportNote(version) {
      const v = parseFloat(version);
      if (v <= 6.0) return "Supported on 90%+ devices âœ…";
      if (v <= 12.0) return "Supported on most modern devices âœ…";
      if (v <= 14.0) return "May not appear on older systems âš ï¸";
      return "Limited support on older platforms âš ï¸";
    }

    // ä¸»è¦åˆ†æå‡½å¼ï¼Œè§£æè¼¸å…¥æ–‡å­—ä¸¦ç”¢ç”Ÿå¤šå€‹æª¢æŸ¥çµæœå€å¡Š
    async function analyzeText() {
      const text = document.getElementById("userInput").value;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = '';

      // è¼‰å…¥ Emoji æ”¯æ´è³‡æ–™
      const dataset = await loadEmojiSupportData();
      const segmenter = new Intl.Segmenter("en", { granularity: "grapheme" });
      const chars = Array.from(segmenter.segment(text), s => s.segment);

      // å»ºç«‹ã€Œè¢å¹•é–±è®€å™¨è¼¸å‡ºã€å€å¡Šï¼Œå°‡ Emoji æ›¿æ›æˆæ–‡å­—æ¨™ç±¤æ–¹ä¾¿èªéŸ³æœ—è®€
      const readerCard = document.createElement("div");
      readerCard.className = "card result-card p-3";
      const readerText = chars.map(c => {
        if (isEmoji(c)) {
          const info = findEmojiInfo(c, dataset);
          return `<span>'${info ? info.label : c}'</span>`; // è½‰æˆæ¨™ç±¤å­—ä¸²
        }
        return `<span>${c}</span>`;
      }).join('');

      readerCard.innerHTML = `
        <h5>Screen Reader Output ğŸ”Š</h5>
        <p class="text-muted">Listen to how it sounds with a screen reader.</p>
        <div class="screen-reader-text" aria-hidden="true">${readerText}</div>
        <button class="btn btn-outline-secondary mt-2" onclick="playText('${text.replace(/'/g, "\\'")}')" aria-label="Play screen reader simulation" tabindex="0">â–¶ Play</button>
      `;
      resultsDiv.appendChild(readerCard);


      // åµæ¸¬é€£çºŒé‡è¤‡çš„ Emojiï¼Œä¸¦é¡¯ç¤ºçµæœ
      const repeatedList = findRepeatedEmojiOnly(text);
      const repeatedCard = document.createElement("div");
      repeatedCard.className = "card result-card p-3";
      let repeatedStatus = 'No excessive repetition detected âœ…';
      let repeatedClass = 'status-success';
      if (repeatedList.length > 0) {
        repeatedStatus = 'Found repeated emoji âŒ: ' + repeatedList.map(e => `${e.emoji} (${e.count} times)`).join(', ');
        repeatedClass = 'status-error';
        repeatedCard.classList.add('highlight-error');
      }
      repeatedCard.innerHTML = `
        <h5>Repeated Emoji ğŸ”</h5>
        <p class="text-muted">Avoid using continuous and repeated emoji.</p>
        <p class="${repeatedClass}">${repeatedStatus}</p>
      `;
      resultsDiv.appendChild(repeatedCard);

      // æª¢æŸ¥å…§å®¹æ˜¯å¦ä»¥ Emoji é–‹é ­
      const startsWithEmoji = /^[\u231A-\uD83E\uDDFF]/.test(text);
      const positionCard = document.createElement("div");
      positionCard.className = "card result-card p-3";
      if (startsWithEmoji) positionCard.classList.add('highlight-error');
      positionCard.innerHTML = `
        <h5>Position of Emoji ğŸ“</h5>
        <p class="text-muted">Ensure emojis are not at the beginning of the content.</p>
        <p class="${startsWithEmoji ? 'status-error' : 'status-success'}">
          ${startsWithEmoji ? 'Emoji found at the beginning of the sentence âŒ' : 'Emoji is well positioned âœ…'}
        </p>
      `;
      resultsDiv.appendChild(positionCard);

      // é¡¯ç¤ºè¼¸å…¥ä¸­æ‰€æœ‰ç¨ç‰¹ Emoji çš„æ”¯æ´åº¦èˆ‡ Unicode ç‰ˆæœ¬è³‡è¨Š
      const supportedCard = document.createElement("div");
      supportedCard.className = "card result-card p-3";
      supportedCard.innerHTML = `
        <h5>Supported Emoji ğŸ“±</h5>
        <p class="text-muted">Check platform support and Unicode version.</p>
      `;

      const emojiList = [...new Set(chars.filter(isEmoji))];
      emojiList.forEach(char => {
        const info = findEmojiInfo(char, dataset);
        if (info) {
          const supportText = getSupportNote(info.version);
          supportedCard.innerHTML += `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold fs-5 mb-1">${char} ${info.label}</div>
              <div class="text-muted">Unicode ${info.version}</div>
              <div class="text-success">${supportText}</div>
            </div>
          `;
        } else {
          supportedCard.innerHTML += `
            <div class="border rounded p-2 mb-2">
              <div class="fw-bold fs-5 mb-1">${char}</div>
              <div class="text-warning">Not found in database âš ï¸</div>
            </div>
          `;
        }
      });
      resultsDiv.appendChild(supportedCard);
    }

    // ä½¿ç”¨ Web Speech API æ’­æ”¾è¼¸å…¥æ–‡å­—çš„èªéŸ³ï¼Œä¸¦æ­é…è¢å¹•é–±è®€å™¨çš„å­—å…ƒé«˜äº®
    function playText(text) {
      const utterance = new SpeechSynthesisUtterance();
      utterance.lang = "en-US";
      const spans = document.querySelectorAll(".screen-reader-text span");
      let index = 0;
      utterance.text = text;
      utterance.onboundary = (event) => {
        if (event.name === 'word') {
          spans.forEach(span => span.classList.remove('active'));
          if (spans[index]) spans[index].classList.add('active');
          index++;
        }
      };
      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
